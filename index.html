<!DOCTYPE html>
<html>
  <head>
    <title>PixieReport via Browser Runtime</title>
    <!-- Lea Verou style emoji favicon, but first declare UTF-8 encoding  -->
    <meta charset="UTF-8">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå¶Ô∏è</text></svg>">

<!--    <script src="pixifier/pixies/pixieselfie/dolldesc.js" />  -->
<script type="module">
import * as parser from './pixifier/decoded-metar-parser.js'; 

      function loadAndComposeOver(drawcontext, paths) {
        if (paths.length < 1) {
          return;
        }
        const headpath = paths[0];
        const tailpath = paths.slice(1);
        // if there are more layers to load, set up another load after painting the layer
        // because they have to paint in the given order
        let tailcall = () => { loadAndComposeOver(drawcontext, tailpath); };

        const loader = new Image();
        loader.addEventListener(
          "load",
          () => {
            // execute drawImage statements here,
	    // compositing layers onto canvas
            drawcontext.drawImage(loader, 0, 0);
            tailcall();
          },
          false
        );

        loader.src = headpath; // fetch!
      }

      function draw() {
        // (MDN Canvas tutorial)

        // loadimg callback requires a reference to the Canvas element
        // so let's make a Canvas element
        const canvas = document.createElement("canvas");
        canvas.setAttribute("width", 125);
        canvas.setAttribute("height", 175);
        const ctx = canvas.getContext("2d");
        ctx.fillStyle = "#f0f"; // magenta for base layer before compositing
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // hide the static image using the DOM API
        const pixieimg = document.images[0];
        pixieimg.style = "display: none";

        const layerFilesToCompose = [ "pixifier/pixies/backgrounds/nightcometbkg.png", 
                                      "pixifier/pixies/pixieselfie/pixie-cool.png" ];

        loadAndComposeOver(ctx, layerFilesToCompose);       // async load-and-paint canvas
        // -- this would be the place to add canvas text -- // async load-and-paint canvas
        pixieimg.parentNode.insertBefore(canvas, pixieimg); // sync add canvas element to DOM
      }

      async function loadSomeText(station) {
        const metarText = await fetch("metar/"+station+".TXT").then( body => body.text());
        const metarDiv = document.createElement("div");
        metarDiv.innerHTML = '<pre>' + metarText + '</pre>';
	// can we parse it?
	const pixieParam = parser.decodedToParamObject(metarText); 
	const pixieJSON = JSON.stringify(pixieParam);
        const jsonDiv  = document.createElement("div");
	jsonDiv.innerHTML = 'The pixie param JSON is:<br/>' + pixieJSON + '<br />The value of stationDesc from the params is: <tt>' + pixieParam.stationDesc + '</tt>';
        const pixiei = document.images[0]; // invisible placeholder image by this point I think
        pixiei.parentNode.insertBefore(jsonDiv, pixiei); // sync add element to DOM
        pixiei.parentNode.insertBefore(metarDiv, pixiei); // sync add element to DOM
      }

      function processMetarQuery() {
        let params = new URL(document.location).searchParams;
        let metar = params.get("metar");
        let qType = typeof(metar);
        if (qType == "string") {
          metarlocation = document.getElementById("metarlocation", null);
          metarlocation.innerHTML = metar;
          metarinput = document.getElementById("metarinput", null);
          metarinput.value = metar;
        }
	// return the value for use in looking up weather reports
	const known = ["ZGOW", "KBFI", "KSEA" ];
	return known.includes(metar) ? metar : "KSEA";
      }

      function handleOnload() {
         let metar = processMetarQuery();
         loadSomeText(metar);
         draw();
      }

     handleOnload();
    </script>
  </head>
  <body >
    <img src="pixifier/pixies/backgrounds/starrynightbkg.png"/>
    <!-- dynamic content inserted in DOM here -->
    <p>
    Report for <a href="/index.html?metar=KSEA" />KSEA</a>.<br/>
    Report for <a href="/index.html?metar=ZGOW" />ZGOW</a>.<br/>
    Report for <a href="/index.html?metar=KBFI" />KBFI</a>.<br/>
    Report for <a href="/index.html?metar=KBLI" />KBLI</a>.<br/>
    </p>
    <p>
    <form action="/index.html" method="get">
    <label>Enter a METAR code like KSEA, ZGOW, KBFI, KBLI: <input id="metarinput" type="text" value="KSEA" name="metar" width="6" /></label> <input type="submit" value="sUBMIT qUERY"/>
    </form>
    </p>
    <p>
    We're loading this page with the METAR station code:
    <span id="metarlocation">(none)</span>
    </p>
    In-browser pixie <a href="tasks/in-browser-composer.html">tasks and milestones</a>
  </body>
</html>
